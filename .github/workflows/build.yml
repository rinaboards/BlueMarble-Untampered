name: Bump, Build, Release

on:
  push:
    branches:
      - main

jobs:
  # Builds the code
  # This is bundling, obfuscating, version bumping, etc.
  build:
    permissions:
      contents: write
    
    runs-on: ubuntu-latest

    outputs:
      TITLE: ${{ steps.get-commit-message.outputs.TITLE }}
      BODY: ${{ steps.get-commit-message.outputs.BODY }}
      CURRENT_VERSION: ${{ steps.get_version.outputs.current_version }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install dependencies
        run: npm install

      # TODO: target the meta in main.js
      #- name: Update userscript version
      #  run: |
      #    npm version minor --no-git-tag-version
      #    node build/update-version.js

      - name: Build userscript
        run: npm run build

      - name: Get current version
        id: get_version
        run: |
          current_version=$(jq -r '.version' package.json)
          echo "Current version: $current_version"
          echo "current_version=$current_version" >> $GITHUB_OUTPUT

      - name: Get latest release tag (no "v" prefix)
        id: get_latest_tag
        run: |
          latest_tag=$(gh release list --limit 1 --exclude-drafts --exclude-pre-releases=false | head -n 1 | awk '{print $1}')
          latest_tag_no_v=${latest_tag#v}
          echo "latest_tag_no_v=$latest_tag_no_v" >> $GITHUB_OUTPUT
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Get the previous commit message
        id: get-commit-message
        run: |
          COMMIT_MSG="$(git log -1 --pretty=%B)"
          TITLE="$(echo "$COMMIT_MSG" | head -n1)"
          BODY="$(echo "$COMMIT_MSG" | tail -n +2)"

          {
            echo "TITLE<<EOF"
            echo "$TITLE"
            echo "EOF"
            echo "BODY<<EOF"
            echo "$BODY"
            echo "EOF"
          } >> $GITHUB_OUTPUT

      - name: Archive dist directory
        run: |
          DIST_ZIP=dist-${{ steps.get_version.outputs.current_version }}.zip
          echo "Creating $DIST_ZIP"
          zip -r "$DIST_ZIP" dist
          echo "DIST_ZIP=$DIST_ZIP" >> $GITHUB_ENV

      - name: Create or update GitHub release
        id: create_release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.get_version.outputs.current_version }}
          name: v${{ steps.get_version.outputs.current_version }}
          body: |
            ${{ steps.get-commit-message.outputs.TITLE }}
            
            ${{ steps.get-commit-message.outputs.BODY }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload dist zip to release
        uses: actions/upload-release-asset@v1
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ${{ env.DIST_ZIP }}
          asset_name: ${{ env.DIST_ZIP }}
          asset_content_type: application/zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Done
        run: |
          echo "Release v${{ steps.get_version.outputs.current_version }} created/updated and dist uploaded."
