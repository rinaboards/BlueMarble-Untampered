name: Build and Deploy

on:
  push:
    branches:
      - main

jobs:

  build-and-deploy:
    permissions:
      contents: write

    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install dependencies
        run: npm install

      - name: Bump version (minor)
        run: |
          npm version minor --no-git-tag-version
          node build/update-version.js

      - name: Build userscript
        run: npm run build

      - name: Get current version
        id: get_version
        run: |
          current_version=$(node -p "require('./package.json').version")
          echo "current_version=$current_version" >> $GITHUB_OUTPUT

      - name: Commit version bump to main
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git remote set-url origin https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}
          git add package.json src/BlueMarble.meta.js
          git diff --staged --quiet || git commit -m "chore: bump version to ${{ steps.get_version.outputs.current_version }} [skip ci]"
          git push origin main

      - name: Deploy to dist branch
        run: |
          cd /tmp
          git init dist-deploy
          cd dist-deploy
          git remote add origin https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}

          cp $GITHUB_WORKSPACE/dist/BlueMarble.user.js .
          cp $GITHUB_WORKSPACE/dist/BlueMarble.user.css .
          cp $GITHUB_WORKSPACE/dist/loader.html .
          mkdir -p assets
          cp -r $GITHUB_WORKSPACE/dist/assets/. assets/

          git checkout -b dist
          git add .
          git commit -m "Deploy v${{ steps.get_version.outputs.current_version }}"
          git push --force origin dist

